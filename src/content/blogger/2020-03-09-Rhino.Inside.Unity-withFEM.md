---
path: "/blog/2020/03/Rhino.Inside.Unity-withFEM"
title: "RhinoInside を使ってリアルタイムで人の動きのFEM解析をやってみる"
date: "20/03/09"
originalUrl: "https://rgkr-memo.blogspot.com/2020/03/Rhino.Inside.Unity-withFEM.html"
slug: "/blog/2020/03/Rhino.Inside.Unity-withFEM"
tags:
    - karamba
    - Unity
    - VR
    - RhinoInside
    - C#
---
<div class="separator" style="clear: both; text-align: left;">　バーチャルモーションキャプチャーとRhino.Inside.Unityを使って以下の動画のような形で人型に対するリアルタイムでのFEM解析をやってみます。</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-X7Wmy3d32-c/XmW2fkPcgWI/AAAAAAAAB0g/3LxrkN8GmLUOFBorIu-ZTqh_WuhJhyoDQCLcBGAsYHQ/s320/VMCmoment.gif)](https://1.bp.blogspot.com/-X7Wmy3d32-c/XmW2fkPcgWI/AAAAAAAAB0g/3LxrkN8GmLUOFBorIu-ZTqh_WuhJhyoDQCLcBGAsYHQ/s1600/VMCmoment.gif)</div><div class="separator" style="clear: both; text-align: center;">  
</div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div>  
　大きな流れとしては、以下の形です。  

1.  [バーチャルモーションキャプチャー](https://sh-akira.github.io/VirtualMotionCapture/)で機器からの情報を取得
2.  [EVMC4U](https://github.com/gpsnmeajp/EasyVirtualMotionCaptureForUnity)を使ってバーチャルモーションキャプチャーからの情報をUnityに取得する
3.  Rhino.Inside.Unityで各ボーンの情報をRhinoに送る
4.  karambaでFEM解析<div>　バーチャルモーションキャプチャー（以下ばもきゃ）とEVMC4Uについての詳細は、上記のリンクから各ソフトのHPでのそれぞれの説明を確認してください。  
　上記の動画ではVIVEとVIVEトラッカーを3つ使って頭、両手、腰、両足をトラッキングしながら撮影しています。</div><div>  
</div><div>　ばもきゃとEVMC4Uの接続については、[EVMC4Uのwiki](https://github.com/gpsnmeajp/EasyVirtualMotionCaptureForUnity/wiki)を参照してください。</div><div>　ばもきゃとのやり取りでハマった箇所としては、ばもきゃとEVMC4UはOSCで情報のやり取りをしていますが、送られているボーン位置の情報はローカル座標で送らている点です。最初はグローバルの座標で送られていると思いそのまま座標をRhinoに送ろうとしていましたが、ローカル座標のためボーンが意味不明な位置になってしまい結構悩みました。  

　ここから今回のために変更した個所の説明をします。  
　EVMC4Uを使える段階にするとExternalReceiver.csを使って情報をばもきゃから受信する形になっていると思います。ここにRhinoへボーン情報を送信用の部分を以下の18行目からの個所のように追記しています。ExternalReceiver.cs全体でいうと576行目くらいから始まる private void BoneSynchronizeSingle の個所になります。</div><div>  
</div>   
<div>　ここではばもきゃから受信したボーンの各点の座標を各ボーンに適用しているので、その値を取得し対象のボーンの名前とポジションを GrasshopperInUnity.SendBonePosition の引数として入力します。途中の長い if文は今回必要なボーンだけを設定するように場合分けしているだけなので、必要に応じて修正してください。  

　次にGrasshopperInUnityについてです。ここでは参考として[Rhino.Inside.Unityのサンプル2](https://github.com/mcneel/rhino.inside/tree/master/Unity/Sample2)を使用しているので、そこからの追記箇所についての説明になります。追記したものは以下です。  

　最初の動作だった場合<span style="color: #666666;">(<span style="background-color: white; font-family: , " consolas"="" ,="" "liberation="" mono"="" ,="" "menlo"="" ,="" monospace;="" white-space:="" pre;"="">_firstRunがTrue</span>)は</span>、grasshopperを起動させ、Unityをいったんポーズの状態にします。ポーズにする理由は、grasshopperを起動後、.ghファイルを選択し開くまでの間はUnityが止まっていないとRhino.Inside.Unityでの送り先がなくエラーになってしまうからです。  
　6行目以降はボーンの座標をargsにセットしてgrasshopper側で受け取れるようにしています。  
　これで各ボーンの頂点データがgrasshopper側で受け取れるようになったので、あとはその点を使って骨組みを作りkarambaで解析します。  
　一連の説明は以上ですが、冒頭の動画のようにこの動作は非常に重いので、もう少し高速化できたら楽しそうなのですが、それは今後の課題です。</div>