{"componentChunkName":"component---src-templates-blog-post-js","path":"/diary/Rhino.Inside.Unity-withFEM2","result":{"data":{"markdownRemark":{"html":"<p>　<a href=\"https://rgkr-memo.blogspot.com/2020/03/Rhino.Inside.Unity-withFEM.html\">前回の記事</a>で、RhinoInside を使った人の動きのFEM解析をやりましたが、速度が全然出ずちょっと実用に耐えられなかったので、原因を調べて改善したので、その内容についてです。<br>\n改善した結果以下のようになったので、かなりいい感じではないでしょうか。  </p>\n<p><a href=\"https://1.bp.blogspot.com/-7kEpT72OnH0/XncdEshJ9YI/AAAAAAAAB1Q/O5Wf_iQu2CwaFF4BzoJJRzdRh_fiAyLpQCLcBGAsYHQ/s1600/stevia_bar.gif\"><img src=\"https://1.bp.blogspot.com/-7kEpT72OnH0/XncdEshJ9YI/AAAAAAAAB1Q/O5Wf_iQu2CwaFF4BzoJJRzdRh_fiAyLpQCLcBGAsYHQ/s400/stevia_bar.gif\"></a></p>\n<p>　改善するためにはまず原因を調べないといけないので、UnityのProfilerを使って何に一番時間がかかっているかを調べました。ここは以下のUnite の講演のアーカイブを参考にさせていただきました。  </p>\n<p>　結果として原因はUnity内でRhinoに送るために行っているNameCallbackが重いことが分かったのでそこを改善していきます。<a href=\"https://rgkr-memo.blogspot.com/2020/03/Rhino.Inside.Unity-withFEM.html\">前回の記事</a>で書いた以下の10行目です。  </p>\n<p>　問題は、ボーンの各点をポイントとして送っているので、UnityでUpdateが実行されるたびに、ここではNameCallbackが18回（送っているポイントの数分）だけ行われることでした。Profilerによればここに600ms程度かかっていました。2fps程度しか出ていないことになります。<br>\nなのでNameCallbackの回数を減らすことを考えます。9行目での args.Set でポイントを一つだけセットしていては回数を減らせないので、RhinoCommonAPIを調べてみると<br>\nIEnumerable<GeometryBase>が送れるようなので、それを使います。（<a href=\"https://developer.rhino3d.com/wip/api/RhinoCommon/html/M_Rhino_Runtime_NamedParametersEventArgs_Set_3.htm\">ここ参照</a>）<br>\n上記を踏まえて修正した SendBonePosition は以下になります。  </p>\n<p>　2～9行目で、List<GeometryBase>を作って初期化し、19行目で各ボーンのポジションを入れていっています。numはボーンの名前と紐づけていて、例えばnum=0ならHeadのボーンの位置を表すような形にしています。<br>\nそして21行目の if でnumが18のときのみ List をNameCallbackで送るようにしています。これでNameCallbackの回数は 1/18 になったので単純計算でこの箇所の実行速度は600/18 = 33.3ms になるので何とか30fps 程度まで近づけたのではないでしょうか。  </p>\n<p>　他の修正点として18行目にある .ToRhino() の動作を変えました。以前はUnityのVector3型をRhinoのPoint3d型に変換しでポイントを送っていましたが、<a href=\"https://developer.rhino3d.com/wip/api/RhinoCommon/html/T_Rhino_Geometry_Point3d.htm\">Point3dは構造体</a>なのでGeometryBaseにすることはできません。なので、GeometryBaseを継承している<a href=\"https://developer.rhino3d.com/wip/api/RhinoCommon/html/T_Rhino_Geometry_Point.htm\">Point クラス</a>に変換するように以下のように書き換えています。  </p>\n<p>　これで人の運動とか解析したら楽しそうですね。</p>","excerpt":"前回の記事で、RhinoInside を使った人の動きのFEM…","frontmatter":{"date":"22 March, 2020","path":"/diary/Rhino.Inside.Unity-withFEM2","title":"RhinoInside を使ってリアルタイムで人の動きのFEM解析をやってみる　～速度改善編～","tags":["karamba","Unity","VR","RhinoInside","C#"]},"fields":{"readingTime":{"text":"1 min read"}}}},"pageContext":{}},"staticQueryHashes":["3649515864","63159454"]}