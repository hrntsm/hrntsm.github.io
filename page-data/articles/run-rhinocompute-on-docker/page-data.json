{"componentChunkName":"component---src-templates-article-post-js","path":"/articles/run-rhinocompute-on-docker","result":{"data":{"markdownRemark":{"html":"<h2>はじめに</h2>\n<p>Docker を使って RhinoCompute を実行してみます。</p>\n<p>クラウドで、CI を使って RhinoCompute を実行できれば、例えば開発した Grasshopper コンポーネントを Rhino を使ってテストできるので良いのではと考えて試してみました。</p>\n<h2>Docker の支度</h2>\n<h3>インストール</h3>\n<p>Docker は <a href=\"https://www.docker.com/\">Docker のホームページ</a> からインストールしてください。</p>\n<p>Rhino は Windows (.netFrameWork) で動くので Windows Container を対象とした状態にしておいてください。</p>\n<h3>Dockerfile の入手</h3>\n<p>Dockerfile は RhinoCompute の公式リポジトリにあるので、そのままそのリポジトリをクローンしてください。</p>\n<ul>\n<li><a href=\"https://github.com/mcneel/compute.rhino3d\">mcneel/compute.rhino3d</a></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone http://github.com/mcneel/compute.rhino3d.git</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h3>build する</h3>\n<p>クローンしたフォルダで docker bulid します。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">docker</span> build --isolation process -t rhino-compute <span class=\"token builtin class-name\">.</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>多分そのままでは動かないので、Dockerfile を必要に応じて書き換えます。</p>\n<h3>使用する Windows のバージョンをそろえる</h3>\n<p>デフォルトだと Windows 10 version 1809 がインストールされますが、自分が使っている Windows のバージョンとそろえる必要があります。</p>\n<p>2021/03/13 時点で最新の Windows は 20H2 なので、最新にしている方は以下に直します。</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-dockerfile line-numbers\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> mcr.microsoft.com/windows:20H2</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h3>インストールする Rhino バージョンの変更</h3>\n<p>2021/03/13 時点での Dockerfile そのままですと ver 7.2.21021.07001 がインストールされますので、別のバージョンにしたい場合は以下の部分を書き換えてください。\nコメントで書かれている URL にすると最新版に自動でリダイレクトされるそうです。</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-dockerfile line-numbers\"><code class=\"language-dockerfile\"><span class=\"token comment\"># install rhino (with “-package -quiet” args)</span>\n<span class=\"token comment\"># NOTE: edit this if you use a different version of rhino!</span>\n<span class=\"token comment\"># the url below will always redirect to the latest rhino 7 (email required)</span>\n<span class=\"token comment\"># https://www.rhino3d.com/download/rhino-for-windows/7/latest/direct?email=EMAIL</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> curl -fSLo rhino_installer.exe https://files.mcneel.com/dujour/exe/20210121/rhino_en-us_7.2.21021.07001.exe `</span>\n    &amp;&amp; .\\rhino_installer.exe -package -quiet `\n    &amp;&amp; del .\\rhino_installer.exe</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3>Rhino へのプラグインのインストール</h3>\n<p>そのままだと Rhino がインストールされるだけで、プラグインはインストールされないので、必要なものがある場合は Yak の実行も追加します。\nデフォルトではコメントアウトされています。</p>\n<p>以下では jswan というプラグインをインストールしています。</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-dockerfile line-numbers\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> <span class=\"token string\">\"\"</span>C:\\Program Files\\Rhino 7\\System\\Yak.exe<span class=\"token string\">\"\"</span> install jswan</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h3>TOKEN の入力</h3>\n<p>Docker で動かすためには RhinoCompute の課金設定をする必要があります。\n課金は以下でできます。</p>\n<ol>\n<li><a href=\"https://accounts.rhino3d.com/\">Rhino Accounts</a> にアクセスする</li>\n<li>ライセンスのページに行く</li>\n<li>新規チームを作成する</li>\n<li>\"チームの管理\"から\"コア時間課金の管理…\"を選ぶ</li>\n<li>コア時間課金を有効にして保存する</li>\n<li>\n<p>再度コア課金の管理のページに行き、操作 ▼ から Get Auth Token を選ぶ</p>\n<ul>\n<li>この AuthToken を Dockerfile に入れる</li>\n</ul>\n</li>\n</ol>\n<p>6 で取得した Token を Dockerfile の以下の TOKEN の位置に入れます。</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-dockerfile line-numbers\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">ENV</span> RHINO_TOKEN=<span class=\"token string\">\"TOKEN\"</span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h2>RhinoCompute を実行する</h2>\n<p>ビルドできたら以下で Docker で RhinoCompute が実行できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run -p <span class=\"token number\">8080</span>:80 rhino-compute</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>実行に問題がなければ以下のように表示されます。\nタイムスタンプは実行した時間によりますので、環境次第です。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:12 INF<span class=\"token punctuation\">]</span> Compute <span class=\"token number\">1.0</span>.0.0, Rhino <span class=\"token number\">7.4</span>.21067.13001\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:12 INF<span class=\"token punctuation\">]</span> Configuration Result:  \n<span class=\"token punctuation\">[</span>Success<span class=\"token punctuation\">]</span> Name compute.geometry       \n<span class=\"token punctuation\">[</span>Success<span class=\"token punctuation\">]</span> DisplayName rhino.compute   \n<span class=\"token punctuation\">[</span>Success<span class=\"token punctuation\">]</span> Description rhino.compute   \n<span class=\"token punctuation\">[</span>Success<span class=\"token punctuation\">]</span> ServiceName compute.geometry\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:12 INF<span class=\"token punctuation\">]</span> Topshelf v4.1.0.172, .NET Framework v4.0.30319.42000\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:13 INF<span class=\"token punctuation\">]</span> Launching RhinoCore library as ContainerAdministrator\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:26 INF<span class=\"token punctuation\">]</span> Starting listener<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span>: <span class=\"token punctuation\">[</span><span class=\"token string\">\"http://+:80\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:28 INF<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span>/2<span class=\"token punctuation\">)</span> Loading grasshopper\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> Grasshopper has started loading all component libraries\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading Grasshopper core assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading CurveComponents assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading FieldComponents assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading GalapagosComponents assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading IOComponents assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading Kangaroo2Component assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading MathComponents assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading ScriptComponents assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading SurfaceComponents assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading TriangulationComponents assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading VectorComponents assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading XformComponents assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> * Loading GhPython assembly<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span>/2<span class=\"token punctuation\">)</span> Loading compute plug-ins\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> Listening on <span class=\"token punctuation\">[</span><span class=\"token string\">\"http://+:80\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">18</span>:19:31 INF<span class=\"token punctuation\">]</span> The compute.geometry <span class=\"token function\">service</span> is now running, press Control+C to exit.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>ブラウザで \"localhost:8080/version\" を入れて、以下のようにバージョンが帰ってくれば問題なく動いています。\n値は環境により異なります。</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-json line-numbers\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"rhino\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"7.0.20259.15365\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"compute\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.0.0.493\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"git_sha\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"a612c257\"</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上記で Control＋C で終了できると書いてありますが、多分それを行っても Docker の表示が閉じられるだけで、RhinoCompute 自体は動いています。</p>\n<p>以下のコマンドで状態が確認できます。</p>\n<p>ここでは STATUS の欄にあるように 55 秒前に起動された状態で、RhinoCompute は動いたままなので、<strong>RhinoCompute の課金もアクティブなまま（注意）</strong> です。\nCONTAINER ID と NAMES は環境によって異なる値になります。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token function\">ps</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">CONTAINER ID   IMAGE           COMMAND                  CREATED              STATUS          PORTS                  NAMES\n0b3733eee521   rhino-compute   <span class=\"token string\">\"compute.geometry.exe\"</span>   About a minute ago   Up <span class=\"token number\">55</span> seconds   <span class=\"token number\">0.0</span>.0.0:8080-<span class=\"token operator\">></span><span class=\"token number\">80</span>/tcp   quirky_elgamal</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>以下のコマンドで停止できます。\n{NAMES} の箇所は ps コマンドで出てくる NAMES を入れてください。</p>\n<p>停止していると ps コマンドでは表示されなくなりますが、明示的に確認したい場合は、-a オプションで確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">docker</span> stop <span class=\"token punctuation\">{</span>NAMES<span class=\"token punctuation\">}</span>\n<span class=\"token function\">docker</span> <span class=\"token function\">ps</span> -a</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>-a オプションでの表示は以下です。\nSTATUS が Exit になっていてちゃんと終了していることがわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">CONTAINER ID   IMAGE           COMMAND                  CREATED         STATUS                              PORTS     NAMES\n0b3733eee521   rhino-compute   <span class=\"token string\">\"compute.geometry.exe\"</span>   <span class=\"token number\">4</span> minutes ago   Exited <span class=\"token punctuation\">(</span><span class=\"token number\">3221225786</span><span class=\"token punctuation\">)</span> <span class=\"token number\">3</span> minutes ago             quirky_elgamal</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>これで Docker を使って簡単に RhinoCompute ができるようになりました！</p>\n<h2>ちなみに</h2>\n<p>始めた後に気づきましたが、GitHub Actions では Windows Container を使えないっぽいので、別のサービスを使う必要があるみたいでした。</p>\n<p>Azure ならできるんでしょうか。</p>\n<h2>使った Dockerfile</h2>\n<p>私が使った Dockerfile の全文を以下に上げます。\nTOKEN は自分のものに書き換えてください。</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-dockerfile line-numbers\"><code class=\"language-dockerfile\"><span class=\"token comment\">### builder image</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> mcr.microsoft.com/dotnet/framework/sdk:4.8 <span class=\"token keyword\">as</span> builder</span>\n\n<span class=\"token comment\"># copy everything, restore nuget packages and build app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> src/ ./src/</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> msbuild /p:Configuration=Release /restore /v:Minimal src/compute.sln</span>\n\n<span class=\"token comment\">### main image</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> mcr.microsoft.com/windows:20H2</span>\n\n<span class=\"token comment\"># install .net 4.8 </span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> curl -fSLo dotnet-framework-installer.exe https://download.visualstudio.microsoft.com/download/pr/7afca223-55d2-470a-8edc-6a1739ae3252/abd170b4b0ec15ad0222a809b761a036/ndp48-x86-x64-allos-enu.exe `</span>\n    &amp;&amp; .\\dotnet-framework-installer.exe /q `\n    &amp;&amp; del .\\dotnet-framework-installer.exe `\n    &amp;&amp; powershell Remove-Item -Force -Recurse ${Env:TEMP}\\*\n\n<span class=\"token comment\"># install rhino (with “-package -quiet” args)</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> curl -fSLo rhino_installer.exe https://www.rhino3d.com/download/rhino-for-windows/7/latest/direct?email=EMAIL `</span>\n    &amp;&amp; .\\rhino_installer.exe -package -quiet `\n    &amp;&amp; del .\\rhino_installer.exe\n\n<span class=\"token comment\"># copy compute app to image</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> [<span class=\"token string\">\"/src/bin/Release/compute\"</span>, <span class=\"token string\">\"/app\"</span>]</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n\n<span class=\"token comment\"># bind compute.geometry to port 80</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> RHINO_COMPUTE_URLS=<span class=\"token string\">\"http://+:80\"</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 80</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> RHINO_TOKEN=<span class=\"token string\">\"TOKEN\"</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"compute.geometry.exe\"</span>]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","excerpt":"はじめに Docker を使って RhinoCompute を実行してみます。 クラウドで、CI を使って RhinoCompute を実行できれば、例えば開発した Grasshopper コンポーネントを Rhino を使ってテストできるので良いのではと考えて試してみました。 Docker…","frontmatter":{"date":"13 March, 2021","path":"/articles/run-rhinocompute-on-docker","title":"RhinoCompute を Docker を使って実行する","article_tags":["RhinoCompute","Docker"]},"fields":{"readingTime":{"text":"4 min read"},"slug":"/run-rhinocompute-on-docker/","collection":"article"}},"site":{"siteMetadata":{"title":"構造とデジタル_最新版_Final(1)"}}},"pageContext":{}},"staticQueryHashes":["32046230","3649515864"]}